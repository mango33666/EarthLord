# EarthLord 产品需求文档 (PRD)

## 文档信息
- **产品名称**: EarthLord（地球领主）
- **版本**: v1.0
- **文档创建日期**: 2025-12-27
- **产品类型**: LBS生存游戏（iOS）
- **目标平台**: iOS (SwiftUI)

---

## 1. 产品概述

### 1.1 产品定位
EarthLord是一款基于真实地理位置的末日求生主题移动游戏，结合GPS定位、AR探索、建造养成和社交互动，为玩家提供"Walk to Earn"的独特游戏体验。

### 1.2 产品愿景
打造全球首款"希望朋克"主题的LBS生存游戏，让玩家在现实世界中探索、圈地、建设，体验末日后重建文明的史诗旅程。

### 1.3 目标用户
- **核心用户**: 18-35岁，喜欢户外活动、探索城市的年轻群体
- **次要用户**: 生存游戏爱好者、社交游戏玩家
- **地域**: 全球175个国家和地区（iOS App Store覆盖范围）

### 1.4 核心价值主张
- **Walk to Earn**: 走路就能获得游戏资源和奖励
- **真实世界互动**: 现实中的地标变成游戏中的资源点
- **社交协作**: 基于位置的玩家互动和交易
- **深度养成**: 领地建设、资源管理、生存挑战

---

## 2. 游戏世界观

### 2.1 背景故事
**2048年** - "终末战争"爆发，全球文明在72小时内崩塌，99%的人口消失

**2051年** - 幸存者从废墟中走出，《新开拓者协议》颁布

**核心法则** - "凡以双足丈量之无主土地，皆为开拓者所有"

### 2.2 视觉风格
**希望朋克** - 废土之上的新生，绝望中的希望。废墟上长出绿色植物，破败建筑上闪烁着新生的光芒。

---

## 3. 核心游戏循环

```
登录注册 → 圈地占领 → 探索搜刮 → 获得资源
   ↑                              ↓
   │         资源用途：
   │         • 建造建筑（消耗资源）
   │         • 交易换物（流通资源）
   │         • 生存消耗（食物/水）
   │                              ↓
   └──────── 通讯社交 ← 成就排行 ← 发展壮大
```

---

## 4. 功能需求详述

### 4.1 用户系统

#### 4.1.1 登录注册系统
**优先级**: P0（核心功能）

**功能描述**:
- 支持邮箱注册登录（用户名+密码）
- 支持Apple ID一键登录（OAuth 2.0）
- 支持Google账号登录（OAuth 2.0）
- 自动会话管理和多设备同步

**技术实现**:
- 使用Supabase Auth进行用户认证
- 实现邮箱验证和密码重置流程
- 支持JWT token自动刷新

**验收标准**:
- 新用户可成功注册并登录
- OAuth登录成功率 > 95%
- 会话保持时长 > 30天
- 支持跨设备登录状态同步

---

### 4.2 圈地系统

#### 4.2.1 GPS圈地功能
**优先级**: P0（核心玩法）

**功能描述**:
- 使用GPS实时追踪玩家位置
- 在地图上绘制玩家移动轨迹（蓝色线条）
- 自动检测轨迹闭合，形成多边形领地
- 验证领地合法性（面积、形状、重叠检测）

**业务规则**:
- 最小面积: 100m²
- 最大面积: 1,000,000m²
- 不允许与其他玩家领地重叠
- 防作弊检测（速度异常、GPS漂移）

**技术实现**:
- 使用Apple MapKit进行地图渲染
- CLLocationManager获取GPS坐标
- PostGIS进行地理空间计算和重叠检测
- 实时轨迹点存储和同步

**验收标准**:
- GPS定位精度 < 10米
- 轨迹刷新率 > 1次/秒
- 闭合检测准确率 > 99%
- 重叠检测响应时间 < 2秒

#### 4.2.2 领地管理
**优先级**: P0

**功能描述**:
- 查看领地列表（名称、面积、建筑数量）
- 编辑领地名称
- 开启/关闭交易开关
- 查看领地内建筑分布
- 领地回收机制（30天未建设/90天未活跃）

**数据模型**:
```
Territory:
- id: UUID
- owner_id: UUID (外键)
- name: String
- geometry: Polygon (PostGIS)
- area: Float (平方米)
- created_at: Timestamp
- allow_trade: Boolean
- building_count: Integer
```

---

### 4.3 探索系统

#### 4.3.1 POI发现与搜刮
**优先级**: P0（核心玩法）

**功能描述**:
- 自动检测玩家附近的真实POI（兴趣点）
- 玩家进入100米范围触发"发现"提示
- 点击"搜刮"获得对应类型的资源
- 每个POI有冷却时间（6小时）

**POI类型与资源映射**:
| POI类型 | 资源类型 | 数量范围 |
|--------|---------|---------|
| 医院/药店 | 药品（急救包、抗生素） | 5-15 |
| 超市/餐厅 | 食物（罐头、饮用水） | 10-30 |
| 工厂/工地 | 金属材料 | 8-20 |
| 公园/林地 | 木材 | 10-25 |
| 银行/珠宝店 | 稀有材料 | 1-5 |

**技术实现**:
- 使用MapKit的MKLocalSearch查询附近POI
- 地理围栏（Geofencing）检测进入范围
- Supabase数据库记录搜刮历史和冷却时间

**验收标准**:
- POI识别准确率 > 90%
- 进入范围触发延迟 < 3秒
- 冷却时间准确无误差

#### 4.3.2 探索统计
**功能描述**:
- 记录探索距离（累计里程）
- 记录探索时长
- 显示探索成就

---

### 4.4 资源管理系统

#### 4.4.1 背包系统
**优先级**: P0

**功能描述**:
- 查看所有拥有的物品和数量
- 背包容量限制（初始100格）
- 物品分类展示（食物、材料、工具、稀有）
- 使用物品功能
- 本地优先存储+云端同步

**数据模型**:
```
Inventory:
- id: UUID
- user_id: UUID
- item_id: String
- quantity: Integer
- updated_at: Timestamp

Item (配置表):
- id: String
- name: String (多语言)
- category: Enum (food/material/tool/rare)
- icon: String (资源路径)
- max_stack: Integer
```

**技术实现**:
- 本地使用SwiftData/CoreData缓存
- 后台异步同步到Supabase
- 离线模式支持

**验收标准**:
- 离线查看背包无延迟
- 网络恢复后自动同步成功率 > 99%
- 并发操作数据一致性保证

---

### 4.5 建造系统

#### 4.5.1 建筑建造
**优先级**: P0

**功能描述**:
- 浏览15种建筑模板
- 查看建造所需资源
- 检查资源是否足够
- 拖动放置建筑位置（仅限自己的领地内）
- 建造成功后扣除资源

**建筑分类**:
1. **生存类**: 篝火、庇护所
2. **储存类**: 小仓库、中仓库、大仓库
3. **生产类**: 农田、工作台、采矿场
4. **能源类**: 太阳能板、风力发电机

**建筑等级**:
- Tier 1: 基础建筑（需基础资源）
- Tier 2: 进阶建筑（需Tier 1前置）
- Tier 3: 高级建筑（需Tier 2前置+稀有资源）

**验收标准**:
- 资源检查准确率 100%
- 建造成功后数据库和UI同步 < 1秒
- 建筑位置精确保存

#### 4.5.2 建筑状态管理
**优先级**: P1

**功能描述**:
- 建筑状态机: 建造中 → 待激活 → 运行中 ⇄ 损坏
- 激活建筑
- 升级建筑
- 维修损坏的建筑

**状态转换规则**:
- 建造完成后 → 待激活
- 激活需要消耗能源
- 运行中的建筑可升级
- 随机损坏事件（概率性）

---

### 4.6 交易系统

#### 4.6.1 玩家交易
**优先级**: P1

**功能描述**:
- 发布交易挂单（我提供X，我需要Y）
- 查看附近玩家的挂单（100米范围内+开启交易的领地）
- 接受交易
- 交易历史记录

**业务规则**:
- 只能看到100米内且允许交易的玩家挂单
- 交易双方资源即时扣除和增加
- 支持批量交易（一次交易多个物品）

**数据模型**:
```
Trade:
- id: UUID
- creator_id: UUID
- offer_items: JSON [{item_id, quantity}]
- request_items: JSON [{item_id, quantity}]
- status: Enum (active/completed/cancelled)
- location: Point (PostGIS)
- created_at: Timestamp
```

**验收标准**:
- 范围检测准确
- 交易原子性保证（要么全成功要么全失败）
- 并发交易冲突处理

---

### 4.7 通讯系统

#### 4.7.1 消息中心
**优先级**: P1

**功能描述**:
- 接收官方消息（生存指南、每日任务、公告）
- 消息分类展示
- 消息已读/未读状态

#### 4.7.2 公共频道聊天
**优先级**: P1

**功能描述**:
- 基于位置的公共聊天室（3km范围）
- 实时消息推送（Supabase Realtime）
- 消息历史记录（最近100条）
- 过滤脏话和敏感词

**技术实现**:
- Supabase Realtime订阅
- PostGIS查询3km范围内的用户
- 消息存储在Supabase

**验收标准**:
- 消息延迟 < 1秒
- 范围过滤准确率 100%

#### 4.7.3 频道管理
**优先级**: P2

**功能描述**:
- 创建自定义频道（群组）
- 加入/退出频道
- 频道聊天
- 查看频道成员

#### 4.7.4 PTT呼叫
**优先级**: P2

**功能描述**:
- 长按发送语音消息（模拟对讲机）
- 语音消息自动转文字
- 播放其他玩家的语音

#### 4.7.5 设备等级
**优先级**: P1（付费点设计）

**功能描述**:
- 收音机（默认）: 只能接收，不能发送
- 对讲机（付费/任务解锁）: 3km范围收发
- 营地电台（付费）: 10km范围
- 卫星通讯（付费）: 全球范围

---

### 4.8 个人中心

#### 4.8.1 个人主页
**优先级**: P0

**功能描述**:
- 显示玩家昵称、头像
- 显示幸存者等级
- 显示存活天数（从注册开始计算）
- 显示领地数量和总面积
- 显示建筑数量

#### 4.8.2 多语言设置
**优先级**: P1（出海必备）

**功能描述**:
- 支持简体中文、繁体中文、英文
- 切换语言后重启应用生效
- 所有UI文字和资源名称多语言化

**技术实现**:
- 使用iOS原生Localizable.strings
- 资源配置表支持多语言字段

---

### 4.9 商业化系统

#### 4.9.1 付费订阅
**优先级**: P0（变现核心）

**功能描述**:
1. **订阅制（自动续费）**:
   - 开拓者月卡: $9.99/月
     - 无限探索次数
     - 探索范围扩大至5km
     - 背包容量+50
   - 领主通行证: $19.99/月
     - 月卡所有特权
     - 解锁所有通讯设备
     - 专属建筑皮肤

2. **一次性购买**:
   - 初级物资包: $0.99（食物×50、木材×30）
   - 中级物资包: $2.99（稀有材料×10）
   - 高级物资包: $9.99（稀有材料×50+随机史诗建筑）

**技术实现**:
- 使用StoreKit 2
- App Store Connect配置产品
- 订阅状态同步到Supabase

**验收标准**:
- 购买成功率 > 98%
- 订阅自动续费准确
- 恢复购买功能正常

#### 4.9.2 排行榜
**优先级**: P1

**功能描述**:
- 领地面积榜（Top 100）
- 探索废墟榜（搜刮次数）
- 建筑数量榜
- 显示自己的排名

**技术实现**:
- PostgreSQL窗口函数计算排名
- 缓存机制（5分钟刷新一次）

#### 4.9.3 成就系统
**优先级**: P1

**功能描述**:
- 新手成就（引导玩法）
- 进阶成就（挑战目标）
- 稀有成就（炫耀资本）
- 成就奖励（金币）

**成就示例**:
- 末世拾荒者: 完成第一次搜刮 → 奖励100金币
- 新手领主: 完成第一次圈地 → 奖励200金币
- 建筑大师: 建造10个建筑 → 奖励500金币

**技术实现**:
- EventBus发布-订阅模式
- 成就进度实时更新

---

### 4.10 生存系统

#### 4.10.1 生存体征
**优先级**: P1

**功能描述**:
- 核心生命值（0-100，降至0则死亡）
- 饱食度（0-100%，随时间衰减 -5/小时）
- 水分（0-100%，随时间衰减 -10/小时）
- 饱食度和水分 < 50% 时，生命值开始下降
- 饱食度和水分 > 80% 时，获得增益效果

**使用物品恢复**:
- 罐头食品: +20饱食度
- 饮用水: +30水分
- 急救包: +50生命值

**技术实现**:
- 后台定时器（10分钟检查一次）
- 计算上次检查到现在的时间差，按比例扣除

**验收标准**:
- 衰减计算准确无误差
- App关闭后重新打开，数值正确更新

---

## 5. 非功能需求

### 5.1 性能需求
- 应用启动时间 < 3秒
- GPS定位首次获取 < 5秒
- 地图渲染帧率 > 30 FPS
- 数据库查询响应时间 < 500ms
- 实时消息延迟 < 1秒

### 5.2 兼容性需求
- 支持iOS 16.0及以上版本
- 支持iPhone 8及以上机型
- 适配iPhone和iPad（响应式布局）

### 5.3 安全需求
- 所有API请求使用HTTPS
- 用户密码加密存储（bcrypt）
- JWT token有效期30天，自动刷新
- 防止SQL注入和XSS攻击
- 敏感操作（交易、购买）需要二次确认

### 5.4 可用性需求
- 系统可用性 > 99.5%
- 数据备份频率: 每日
- 灾难恢复时间 < 4小时

---

## 6. 技术架构

### 6.1 技术栈
- **前端**: SwiftUI（iOS 16+）
- **后端**: Supabase（PostgreSQL + PostGIS）
- **认证**: Supabase Auth（OAuth 2.0）
- **实时通讯**: Supabase Realtime
- **地图**: Apple MapKit
- **支付**: StoreKit 2
- **本地存储**: SwiftData / CoreData

### 6.2 第三方服务
- Supabase（BaaS后端服务）
- Apple Maps（地图和POI）
- App Store Connect（应用分发和内购）

### 6.3 数据库设计（Supabase/PostgreSQL）
核心表：
- users（用户表）
- territories（领地表，PostGIS geometry）
- buildings（建筑表）
- inventory（背包物品表）
- trades（交易表）
- messages（消息表）
- channels（频道表）
- achievements（成就表）
- poi_visits（POI访问记录表）

---

## 7. 里程碑规划

### MVP（最小可行产品）阶段
**时间**: 前3周
- 登录注册系统
- GPS圈地功能
- POI发现与搜刮
- 背包系统
- 基础建造系统
- 个人主页

### 第二阶段
**时间**: 第4-6周
- 交易系统
- 公共频道聊天
- 成就系统
- 排行榜

### 第三阶段
**时间**: 第7-8周
- 付费订阅系统
- 生存体征系统
- 多语言支持
- 频道管理和PTT呼叫

---

## 8. 成功指标（KPI）

### 8.1 用户增长指标
- DAU（日活跃用户）> 10,000（上线3个月）
- 次日留存率 > 40%
- 7日留存率 > 25%
- 30日留存率 > 15%

### 8.2 参与度指标
- 日均探索次数 > 5次/用户
- 日均圈地次数 > 1次/用户
- 社交互动率 > 30%（发消息或交易）

### 8.3 变现指标
- 付费转化率 > 5%
- ARPPU（付费用户平均收入）> $15/月
- LTV（用户生命周期价值）> $50

---

## 9. 风险与挑战

### 9.1 技术风险
- GPS定位精度受环境影响（室内、高楼区）
- 作弊风险（GPS模拟、外挂）
- 服务器成本随用户增长快速上升

### 9.2 运营风险
- 玩家作弊行为（GPS欺骗、多开）
- 内容违规（聊天系统的敏感词过滤）
- 玩家流失（游戏深度不足）

### 9.3 法律风险
- 隐私政策（GPS位置数据收集）
- 儿童保护法（COPPA合规）
- 各国游戏法规差异

### 9.4 缓解措施
- 实现防作弊算法（速度检测、轨迹合理性）
- 人工审核+AI过滤敏感内容
- 完善新手引导和成就系统提升留存
- 严格遵守GDPR、COPPA等隐私法规

---

## 10. 附录

### 10.1 术语表
- **LBS**: Location-Based Service，基于位置的服务
- **POI**: Point of Interest，兴趣点
- **Walk to Earn**: 走路赚取奖励的游戏机制
- **Geofencing**: 地理围栏，基于GPS的区域检测
- **PostGIS**: PostgreSQL的地理空间数据库扩展
- **OAuth**: 开放授权标准
- **ARPPU**: Average Revenue Per Paying User，付费用户平均收入
- **LTV**: Lifetime Value，用户生命周期价值

### 10.2 参考资料
- 宝可梦GO游戏设计分析
- Supabase官方文档
- Apple MapKit开发指南
- StoreKit 2最佳实践

---

**文档版本**: v1.0
**最后更新**: 2025-12-27
**文档所有者**: EarthLord产品团队
